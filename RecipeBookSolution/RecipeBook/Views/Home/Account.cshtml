@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["LayoutMode"] = "fullscreen";
}


<div style="margin: auto;">
    <div class="loginFormWrapper">

        @{
            var initialMode = ViewBag.RegisterError != null ? "register" : "login";
        }

        <form id="authForm" class="loginForm" method="post" action="@Url.Action("Login", "Home")" novalidate>
            <div class="title" id="formTitle">Vítejte,<br><span id="formSubtitle">přihlašte se pro pokračování</span></div>
            @Html.AntiForgeryToken()

            <input class="accountInput" id="Email" name="Email" placeholder="Email" type="email" value="@(ViewData["Email"] ?? String.Empty)" />
            <input class="accountInput" id="Password" name="Password" placeholder="Heslo" type="password" />

            <input class="accountInput" id="ConfirmPassword" name="ConfirmPassword" placeholder="Potvrzení hesla" type="password" style="visibility:hidden" value="@(ViewData["ConfirmPassword"] ?? String.Empty)" />

            @* server errors are passed via TempData as JSON and shown only in the modal; do not render inline *@
            <div id="errorBox" data-server-errors='@(TempData["ServerErrors"] ?? "[]")' style="display:none"></div>

            <div class="button-row">
                <button type="button" id="toggleMode" class="button-confirm toggle-btn">Registrovat</button>
                <button type="submit" class="button-confirm" id="submitButton">Přihlásit se →</button>
            </div>
        </form>
    </div>

    <script>
        (function(){
            var mode = '@initialMode'; // login nebo register
            var form = document.getElementById('authForm');
            var confirm = document.getElementById('ConfirmPassword');
            var title = document.getElementById('formTitle');
            var subtitle = document.getElementById('formSubtitle');
            var submit = document.getElementById('submitButton');
            var toggle = document.getElementById('toggleMode');

            function setMode(m){
                mode = m;
                if(mode === 'login'){
                    form.action = '@Url.Action("Login","Home")';
                    confirm.style.visibility = 'hidden';
                    submit.textContent = 'Přihlásit se →';
                    subtitle.textContent = 'přihlašte se pro pokračování';
                    toggle.textContent = 'Ještě nemáte účet?';
                } else {
                    form.action = '@Url.Action("Register","Home")';
                    confirm.style.visibility = 'visible';
                    submit.textContent = 'Registrovat →';
                    subtitle.textContent = 'vytvořte si nový účet';
                    toggle.textContent = 'Již máte účet?';
                }
            }

            // ensure toggle never submits the form
            toggle.setAttribute('type','button');
            toggle.addEventListener('click', function(e){
                e.preventDefault();
                e.stopPropagation();
                setMode(mode === 'login' ? 'register' : 'login');
            });

            // Intercept form submit and send via AJAX so server-side validation errors are shown inline
            form.addEventListener('submit', async function(e){
                e.preventDefault();
                if (confirm) confirm.disabled = (mode === 'login');

                var box = document.getElementById('errorBox');
                box.innerHTML = '';

                try {
                    var fd = new FormData(form);
                    var resp = await fetch(form.action, {
                        method: 'POST',
                        body: fd,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    if (resp.ok) {
                        var data = await resp.json().catch(function(){ return null; });
                        if (data && data.success) {
                            if (data.redirect) {
                                window.location.href = data.redirect;
                                return;
                            }
                            window.location.reload();
                            return;
                        }
                        // fallback: reload
                        window.location.reload();
                        return;
                    }

                    // handle validation errors returned as JSON (400)
                    var err = await resp.json().catch(function(){ return null; });
                    if (err && err.errors) {
                        // show modal with errors
                        showModal(err.errors);
                        if (err.email) document.getElementById('Email').value = err.email;
                        return;
                    }

                    // generic error
                    showModal(["Došlo k chybě, zkuste to prosím znovu."]);

                } catch (ex) {
                    showModal(["Chyba při odesílání požadavku."]);
                } finally {
                    if (confirm) confirm.disabled = false;
                }
            });

            // initialize
            setMode(mode);

            // Collect any server-rendered inline errors inside the form (different helpers/classes)
            function collectAndShowInlineErrors(){
                var msgs = [];

                // #errorBox specific
                var serverBox = document.getElementById('errorBox');
                if (serverBox) {
                    Array.from(serverBox.querySelectorAll('.text-danger')).forEach(function(el){
                        var t = el.textContent && el.textContent.trim();
                        if (t) msgs.push(t);
                    });
                    serverBox.innerHTML = '';
                }

                // look for common validation classes inside the form
                var selectors = ['.input-validation-error', '.field-validation-error', '.validation-summary-errors', '.validation-summary-valid', '.text-danger'];
                selectors.forEach(function(sel){
                    Array.from(form.querySelectorAll(sel)).forEach(function(el){
                        var t = el.textContent && el.textContent.trim();
                        if (t) msgs.push(t);
                        // clear so it doesn't remain in form
                        el.innerHTML = '';
                    });
                });

                // dedupe and show
                msgs = msgs.map(function(s){ return s; }).filter(function(v,i,a){ return v && a.indexOf(v) === i; });
                if (msgs.length > 0) showModal(msgs);
            }

            // Note: do not automatically show server-rendered messages on page load.
            // Modal is shown only for AJAX responses. Server-rendered messages remain inline
            // for non-JS fallback so the user can see them without a modal.
        })();
        
        function showModal(messages){
            var existing = document.getElementById('validationModal');
            if (!existing){
                var overlay = document.createElement('div');
                overlay.id = 'validationModal';
                overlay.className = 'modal-overlay';
                overlay.innerHTML = '<div class="modal-box"><div class="modal-title">Chyby</div><div class="modal-body" id="modalBody"></div><div><button class="modal-close" id="modalClose">Zavřít</button></div></div>';
                document.body.appendChild(overlay);
                document.getElementById('modalClose').addEventListener('click', function(){ overlay.style.display = 'none'; });
            }
            var overlayEl = document.getElementById('validationModal');
            var body = overlayEl.querySelector('#modalBody');
            body.innerHTML = messages.map(function(m){ return '<div class="text-danger" style="margin-bottom:6px">'+m+'</div>'; }).join('');
            overlayEl.style.display = 'flex';
        }
    </script>

</div>




